name: Build

on:
  workflow_dispatch:
  schedule:
    - cron: '30 0 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download Rules
        run: |
          mkdir -p raw
          groups=(
            "Telegram https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/Telegram/Telegram.list"
            "Alibaba https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/Alibaba/Alibaba.list"
            "ByteDance https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/ByteDance/ByteDance.list"
            "Tencent https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/Tencent/Tencent.list"
            "YouTube https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/YouTube/YouTube.list"
            "Twitter https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/Twitter/Twitter.list"
            "DouYin https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/DouYin/DouYin.list"
            "TikTok https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/TikTok/TikTok.list"
            "Github https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/GitHub/GitHub.list"
            "Google https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/Google/Google.list"
            "Spotify https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/Spotify/Spotify.list"
            "Netflix https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/Netflix/Netflix.list"
            "ChinaIPs https://raw.githubusercontent.com/Loyalsoldier/surge-rules/release/ruleset/cncidr.txt"
            "BanAD https://anti-ad.net/surge.txt https://raw.githubusercontent.com/TG-Twilight/AWAvenue-Ads-Rule/main/Filters/AWAvenue-Ads-Rule-Surge-RULE-SET.list https://adrules.top/adrules.list"
            "China https://raw.githubusercontent.com/Loyalsoldier/surge-rules/release/ruleset/direct.txt"
            "Proxy https://raw.githubusercontent.com/Loyalsoldier/surge-rules/release/ruleset/proxy.txt https://raw.githubusercontent.com/Loyalsoldier/surge-rules/release/ruleset/gfw.txt"
            "Apple https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Surge/Apple/Apple_All_No_Resolve.list"
            "AppleCN https://raw.githubusercontent.com/Loyalsoldier/surge-rules/release/ruleset/apple.txt"
            "Meta https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/Facebook/Facebook.list https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/Instagram/Instagram.list https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/Threads/Threads.list https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Surge/Whatsapp/Whatsapp.list"
            "HttpDns https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/BlockHttpDNS/BlockHttpDNS.list"
            "AI https://git.repcz.link/kelee.one/Tool/Loon/Lsr/AI.lsr"
            "Talkatone https://raw.githubusercontent.com/Repcz/Tool/refs/heads/X/Surge/Rules/Talkatone.list"
          )

          for line in "${groups[@]}"; do
            read -r name urls <<< "$line"
            tmp="raw/$name.tmp"
            > "$tmp"
            for url in $urls; do
              curl -sL --fail "$url" >> "$tmp" 2>/dev/null || true
              echo "" >> "$tmp"
            done
            grep -vE '^\s*(#|$)' "$tmp" | sort -u > "raw/$name.clean"
            rm -f "$tmp"
          done

      - name: Icons
        run: |
          mkdir -p Icons/raw Icons/Icons-all Icons/Emby

          sources=(
            "Icons-all https://raw.githubusercontent.com/Koolson/Qure/master/Other/QureColor-All.json https://raw.githubusercontent.com/lige47/QuanX-icon-rule/main/ligeicon.json"
            "Emby https://raw.githubusercontent.com/baiitang/Sakura/main/Fileball/Yuan/tubiao.json"
          )

          for line in "${sources[@]}"; do
            read -r category urls <<< "$line"

            output_file="Icons/${category}.json"
            > raw_icons.jsonl

            i=0
            for url in $urls; do
              raw_json="Icons/raw/${category}_source_${i}.json"
              echo "Downloading $url → $raw_json"
              if ! curl -sL --fail --connect-timeout 15 --retry 2 "$url" -o "$raw_json"; then
                echo "!!! Failed to download $url"
                rm -f "$raw_json"
                ((i++))
                continue
              fi

              if [ ! -s "$raw_json" ]; then
                echo "!!! Empty file after download: $raw_json"
                rm -f "$raw_json"
                ((i++))
                continue
              fi

              echo "Downloaded size: $(stat -c %s "$raw_json") bytes"
              head -n 5 "$raw_json" || true

              jq 'if type == "object" and has("icons") then .icons elif type == "array" then . else [] end' "$raw_json" > icons_temp.jsonl 2> jq_err.log

              if [ -s jq_err.log ]; then
                echo "jq error for $raw_json:"
                cat jq_err.log
                rm -f icons_temp.jsonl jq_err.log
                ((i++))
                continue
              fi

              cat icons_temp.jsonl >> raw_icons.jsonl
              rm -f icons_temp.jsonl jq_err.log

              while IFS= read -r icon_line; do
                if [ -z "$icon_line" ]; then continue; fi
                icon_url=$(echo "$icon_line" | jq -r '.url // empty' 2>/dev/null)
                if [ -z "$icon_url" ] || [[ ! "$icon_url" =~ \.(png|jpg|jpeg|svg|gif)$ ]]; then
                  continue
                fi
                filename=$(basename "$icon_url")
                target_dir="Icons/${category}"
                target_file="${target_dir}/${filename}"
                echo "Downloading icon: $icon_url → $target_file"
                curl -sL --fail --connect-timeout 10 "$icon_url" -o "$target_file" || echo "Icon download failed: $icon_url"
              done < <(jq -c '.[]?' "$raw_json" 2>/dev/null || true)

              ((i++))
            done

            if [ ! -s raw_icons.jsonl ]; then
              echo "No valid icons collected for $category - skipping JSON generation"
              continue
            fi

            jq -s --arg category "$category" '
              add |
              group_by(.name) |
              map(.[0]) |
              {
                name: $category,
                description: (. | length | tostring + "个图标"),
                icons: .
              }
            ' raw_icons.jsonl > "$output_file" 2> gen_err.log

            if [ -s gen_err.log ]; then
              echo "Error generating $output_file:"
              cat gen_err.log
            fi

            count=$(jq '.icons | length' "$output_file" 2>/dev/null || echo 0)
            echo "Generated ${category}.json with $count icons"

            rm -f raw_icons.jsonl gen_err.log

            jq . "$output_file" > temp.json 2>/dev/null && mv temp.json "$output_file" || true
          done

      - name: Loon
        run: |
          mkdir -p Loon/Rules
          for f in raw/*.clean; do
            [[ -s "$f" ]] || continue
            name=$(basename "$f" .clean)
            processed=$(grep -vE '^(PROCESS-NAME|SCRIPT)' "$f" | \
              sed 's/,[[:space:]]*no-resolve[[:space:]]*$//' | \
              sed -E '/^(IP-CIDR|IP-CIDR6|GEOIP|IP-ASN),/ s/$/,no-resolve/')
            count=$(echo "$processed" | grep -cvE '^($|#)')
            {
              echo "# 规则名称: $name"
              echo "# 规则统计: $count"
              echo ""
              echo "$processed"
            } > "Loon/Rules/$name.list"
          done

      - name: Egern
        run: |
          mkdir -p Egern/Rules
          for f in raw/*.clean; do
            [ -s "$f" ] || continue
            name=$(basename "$f" .clean)
            rules=$(grep -E '^(DOMAIN|DOMAIN-SUFFIX|DOMAIN-KEYWORD|DOMAIN-REGEX|IP-CIDR|IP-CIDR6|GEOIP|USER-AGENT|URL-REGEX|IP-ASN),' "$f" | sed 's/,[[:space:]]*no-resolve[[:space:]]*$//' || true)
            count=$(echo "$rules" | grep -c '^' || echo 0)
            [ "$count" -eq 0 ] && continue

            has_ip_rule=$(echo "$rules" | grep -E '^(IP-CIDR|IP-CIDR6|GEOIP|IP-ASN),' | wc -l)

            {
              echo "# 规则名称: $name"
              echo "# 规则统计: $count"
              echo ""
              [ "$has_ip_rule" -gt 0 ] && echo "no_resolve: true" && echo ""

              declare -A RULE_MAP=(
                [DOMAIN]=domain_set
                [DOMAIN-SUFFIX]=domain_suffix_set
                [DOMAIN-KEYWORD]=domain_keyword_set
                [DOMAIN-REGEX]=domain_regex_set
                [IP-CIDR]=ip_cidr_set
                [IP-CIDR6]=ip_cidr6_set
                [GEOIP]=geoip_set
                [USER-AGENT]=user_agent_set
                [URL-REGEX]=url_regex_set
                [IP-ASN]=asn_set
              )

              ORDERED_RULE_TYPES=(DOMAIN DOMAIN-SUFFIX DOMAIN-KEYWORD DOMAIN-REGEX IP-CIDR IP-CIDR6 GEOIP USER-AGENT URL-REGEX IP-ASN)

              for type in "${ORDERED_RULE_TYPES[@]}"; do
                etype="${RULE_MAP[$type]}"
                [ -z "$etype" ] && continue

                trules=$(echo "$rules" | grep "^$type," || true)
                [ -z "$trules" ] && continue

                echo "$etype:"
                if [[ $type =~ ^(DOMAIN-REGEX|USER-AGENT|URL-REGEX|IP-ASN)$ ]]; then
                  echo "$trules" | awk -F, '{printf "  - '\''%s'\''\n", $2}' | sort -u
                else
                  echo "$trules" | awk -F, '{print "  - " $2}' | sort -u
                fi
                echo ""
              done
            } > "Egern/Rules/$name.yaml"
          done

      - name: Commit Changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Loon/Rules/*.list Egern/Rules/*.yaml Icons/*.json Icons/raw/*.json Icons/Icons-all/* Icons/Emby/* 2>/dev/null || true
          git diff --cached --quiet || {
            git commit -m "Auto update rules and icons"
            git push
          }